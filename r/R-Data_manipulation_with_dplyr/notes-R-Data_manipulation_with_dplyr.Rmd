---
title: "Data Manipulation with dplyr"
author: "Paris Zhang"
date: "3/20/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Taught by *Chris Cardillo*, Data Scientist at DataCamp

```{r}
babynames = readRDS("babynames.rds")
counties = readRDS("counties.rds")
```

```{r message=FALSE}
library(dplyr)
```


# 2. Aggregating Data

1. Add weight
```{r}
counties %>%
  count(state, wt = population, sort = TRUE) %>%
  head()
```

2. The `top_n()` verb
```{r}
counties %>%
  select(region, state, county, population, income) %>%
  group_by(region, state) %>%
  # Calculate average income
  summarise(average_income = mean(income)) %>%
  # Find the 2 highest income states in each region
  top_n(2, average_income)
```



# 3. Selecting and Transforming Data

1. Advanced select - `select_helpers`
* `contains()`
* `starts_with()`
* `ends_with()`
* `last_col()`

```{r}
counties %>%
  # Select the state, county, population, and those ending with "work"
  select(state, county, population, ends_with("work")) %>%
  filter(public_work >= 50)
```


2. Renaming one or a few columns
* Use `select()` - `select(..., new = old)`
* Use `rename` - `rename(new = old)`


3. Use `transmute()` to select and mutate - `transmute(state, county, fraction_men = men / population)`


# 4. Case Study: the Babynames Dataset

1. Filter for multiple names - `filter(name %in% c("Amy","Christopher"))`
2. Find the year each name is most common:
```{r}
# Find the year each name is most common 
babynames %>%
  group_by(year) %>%
  mutate(year_total = sum(number)) %>%
  ungroup() %>%
  mutate(fraction = number/year_total*100) %>%
  group_by(name) %>%
  top_n(1,fraction) %>%
  arrange(desc(fraction)) %>%
  head(10)
```

3. Combine `group_by()` and `mutate()`


## Window function
```{r}
v <- c(1, 3, 6, 14)

v
lag(v)
v - lag(v)
```

Example: changes in popularity of a name
```{r}
babynames_fraction <- babynames %>%
  group_by(year) %>%
  mutate(year_total = sum(number)) %>%
  ungroup() %>%
  mutate(fraction = number / year_total)

babynames_fraction %>%
  filter(name == "Matthew") %>%
  arrange(year)
```

Matthew over time:
```{r}
babynames_fraction %>%
  filter(name == "Matthew") %>%
  arrange(year) %>%
  mutate(difference = fraction - lag(fraction))
```

Biggest jump in popularity:
```{r}
babynames_fraction %>%
  filter(name == "Matthew") %>%
  arrange(year) %>%
  mutate(difference = fraction - lag(fraction)) %>%
  arrange(desc(difference))
```


Changes within every name:
```{r}
babynames_fraction %>%
  arrange(name, year) %>%
  mutate(difference = fraction - lag(fraction)) %>%
  group_by(name) %>%
  arrange(desc(difference))
```

Using ratios to describe the frequency of a name:
```{r}
babynames_fraction %>%
  # Arrange the data in order of name, then year 
  arrange(name, year) %>%
  # Group the data by name
  group_by(name) %>%
  # Add a ratio column that contains the ratio between each year 
  mutate(ratio = fraction / lag(fraction))
```

Biggest jumps in a name:
```{r}
babynames_ratios_filtered <- babynames_fraction %>%
  arrange(name, year) %>%
  group_by(name) %>%
  mutate(ratio = fraction / lag(fraction)) %>%
  filter(fraction >= 0.00001)

babynames_ratios_filtered %>%
  # Extract the largest ratio from each name 
  top_n(1, ratio) %>%
  # Sort the ratio column in descending order 
  arrange(desc(ratio)) %>%
  # Filter for fractions greater than or equal to 0.001
  filter(fraction >= 0.001)
```



